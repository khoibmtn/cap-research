# Session Context Snapshot
**Saved:** 2026-02-22 01:22 (UTC+7)
**Branch:** feat/backup-management
**Last Commit:** 8beb6ed feat: add date validation, mobile touch fix, cancel confirmation, workflows & rules

## What Was Done This Session

### Backup & Import System (Major Feature)
- Built complete backup management system with Firebase Storage
- Implemented Excel import with conflict detection
- Created `backupService.ts` — CRUD for backups (create, list, delete, rename, restore)
- Created `importService.ts` — conflict detection, deep diff, `nextMaBNNC()` auto-assignment
- Built `ConflictDialog.tsx` — side-by-side diff viewer with select/deselect
- Added search across backups (sub-tab Tìm kiếm)

### Unified Restore Conflict Resolution
- Deep diff engine comparing ALL Patient fields (80+ fields)
- `stableStringify()` — sorted-key JSON to avoid key-order false diffs
- hoiChung sub-objects compared field-by-field instead of raw JSON
- Unified `handleRestorePatients()` — single + bulk use same handler
- Preserves maBNNC on overwrite, auto-assigns for new patients
- ConflictDialog with summary header (new/conflict/identical counts)

### Confirm Dialog Fix
- Replaced ALL native `confirm()` calls with persistent `ConfirmDialog` modal
- Enhanced `EditGuardContext.showConfirm()` with `title` and `destructive` params
- Delete confirmations now have red destructive button
- Fixed: DashboardPage delete, PatientFormPage delete, PatientFormPage prev/next nav

### User Manual
- Created `instruction.md` — comprehensive user manual in plain Vietnamese
- Added GEMINI.md rule: auto-update instruction.md when features change

## Work In Progress
- All planned features are complete and verified

## Key Files Modified
- `src/services/backupService.ts` — backup CRUD + restore logic (NEW)
- `src/services/importService.ts` — conflict detection + deep diff (NEW)
- `src/components/backup/ConflictDialog.tsx` — conflict resolution UI (NEW)
- `src/pages/SettingsPage.tsx` — backup tab, unified restore flow
- `src/pages/DashboardPage.tsx` — replaced confirm() with modal
- `src/pages/PatientFormPage.tsx` — replaced confirm() with modal
- `src/contexts/EditGuardContext.tsx` — enhanced showConfirm (title, destructive)
- `src/components/ui/ConfirmDialog.tsx` — destructive prop support
- `.agent/rules/GEMINI.md` — added User Manual Sync rule
- `instruction.md` — user manual (NEW)
- `storage.rules` — Firebase Storage rules (NEW)
- `cors.json` — CORS config for Storage (NEW)

## Environment Notes
- Node: v25.2.1
- Firebase project: cap-research-app
- Build: clean (tsc --noEmit passes)

## Important Context for Next Session
- Backup files stored in Firebase Storage under `backups/` prefix
- Auto-backup fires on patient create/update (fire-and-forget)
- `instruction.md` must be updated whenever features change (enforced by GEMINI.md rule)
- All `confirm()` calls have been eliminated — use `showConfirm()` from `useEditGuardConfirm()` hook
- `stableStringify()` in importService ensures no false diffs from JSON key ordering
